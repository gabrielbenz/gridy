/*!
 * jQuery Gridy - A Grid Plugin - http://wbotelhos.com/gridy
 * 
 * @author	Washington Botelho
 * @twitter wbotelhos
 * @version 0.3.0 beta
 * 
 * Licensed under The MIT License
 * http://opensource.org/licenses/mit-license.php
 * 
 */

(function(b){var a={init:function(c){},getSize:function(c){return(isNaN(parseInt(c)))?c:c+"px";},getNumber:function(c){return(c<10)?"0"+c:c;},getError:function(c){return(c.responseText)?c.responseText.substring(c.responseText.indexOf("(")+1,c.responseText.indexOf(")")):c.statusText;},getNumber:function(c){return(c<10)?"0"+c:c;},debug:function(c){if(window.console&&window.console.log){window.console.log(c);}}};b.fn.gridy=function(aa){if(this.length==0){a.debug("Selector invalid or missing!");return;}else{if(this.length>1){return this.each(function(){b.fn.gridy.apply(b(this),[aa]);});}}var y=b.extend({},b.fn.gridy.defaults,aa),O=this.attr("id"),p=b(this).empty(),L=b('<input id="current-page" type="hidden" value="'+y.page+'"/>').appendTo(p),n=b('<input id="current-sort-name" type="hidden" value="'+y.sortName+'"/>').appendTo(p),s=b('<input id="current-sort-order" type="hidden" value="'+y.sortOrder+'"/>').appendTo(p);if(O===undefined){O="gridy-"+p.index();p.attr("id",O);}p.addClass(y.templateStyle).data("options",y);var d=null,R=null,W=null;if(y.searchOption){d=b('<div class="gridy-search"><div class="gridy-search-content"></div></div>').appendTo(p);if(y.resize){d.css("width",a.getSize(y.width));}R=b('<input id="search" type="text" size="40" value="'+((y.search=="")?y.searchText:y.search)+'" title="'+y.searchText+'"/>').appendTo(d.children());R.blur(function(){if(R.val()==""){R.removeClass("gridy-typed").val(y.searchText);}}).focus(function(){if(R.val()==y.searchText){R.addClass("gridy-typed").val("");}}).keypress(function(i){if((i.keyCode?i.keyCode:i.which)==13){P(1,n.val(),s.val());}});W=b('<input type="button" value="'+y.searchButtonLabel+'" title="'+y.searchButtonTitle+'"/>').appendTo(d.children());W.click(function(){P(1,n.val(),s.val());});}function B(ad,ae,ai,ah){var ac=ad.parent().parent(),ag=y.headersName.length>0&&ac.attr("class")=="gridy-header";if(ah){var i=ac.find("a.gridy-sorted").attr("rel","desc").removeClass("gridy-sorted");i=(ag)?i.next("div"):i.prev("div");i.removeClass().addClass(y.arrowNone);}ad.attr("rel",ae).addClass("gridy-sorted");var af=(ag)?ad.next("div"):ad.prev("div");af.removeClass().addClass(ai);}var t=null,J=null;if(y.sortersName.length>0){var A="",T="",K="";for(var Y=0;Y<y.sortersName.length;Y++){T=y.sortersName[Y][0];K=y.sortersName[Y][1];A+='<div class="gridy-sorter-item"><div class="'+y.arrowNone+'"></div><a id="sort-by-'+T+'" href="javascript:void(0);" name="'+T+'" rel="desc">'+K+"</a></div>";}t=b('<div class="gridy-sorter-bar"/>').css("width",a.getSize(y.sorterWidth)).html(A).appendTo(p);J=t.children().children("a").click(H);var D=J.find("a#sort-by-"+y.sortName);if(D.length){var F=(y.sortOrder=="asc")?y.arrowUp:y.arrowDown,w=false;B(D,y.sortOrder,F,w);}}function H(){j(b(this));}function j(i){var ae=i.attr("name"),ad=i.attr("rel"),ac=(ad=="desc")?"asc":"desc",ag=(ad=="desc")?y.arrowUp:y.arrowDown,af=i.parent().parent().find("a.gridy-sorted").length>0;B(i,ac,ag,af);P(L.val(),ae,ac);}var Q=null;if(y.loadingOption||y.resultOption){Q=b('<div class="gridy-status"/>').appendTo(p);if(y.resize){Q.css("width",a.getSize(y.width));}}var U=null;if(y.loadingOption){U=b('<div class="'+y.loadingIcon+'"><div>'+y.loadingText+"</div></div>").appendTo(Q).children();}var G=null;if(y.resultOption){G=b('<div class="gridy-result"/>').appendTo(Q);}var m=null,l=null;if(y.headersName.length>0){m=b('<div class="gridy-header"/>').appendTo(p);if(y.resize){m.css("width",a.getSize(y.width));}var C=null,S=null,o="",M="";if(y.headersWidth.length<=0){if(y.colsWidth.length>0){y.headersWidth=y.colsWidth;}else{a.debug(O+": headersWith and colsWidth attributes invalid or missing!");return;}}for(var Y=0;Y<y.headersName.length;Y++){o=y.headersName[Y][0];M=y.headersName[Y][1];S=b("<a/>",{href:"javascript:void(0);",html:M});C=b('<div class="gridy-head-item"/>');if(o){S.attr({id:"sort-by-"+o,name:o,rel:"desc"});var V=b("<div/>",{"class":y.arrowNone});C.append(S,V);}else{S.attr("class","gridy-no-sort");C.append(S);}if(y.headersName[Y][2]){C.addClass(y.headersName[Y][2]);}C.css("width",y.headersWidth[Y]).appendTo(m);}l=m.children().children('a:not(".gridy-no-sort")').click(H);var D=b(".gridy-header a#sort-by-"+y.sortName);if(D.length){var F=(y.sortOrder=="asc")?y.arrowUp:y.arrowDown,w=false;B(D,y.sortOrder,F,w);}}var f=b('<div class="gridy-content"/>').css({height:a.getSize(y.height),width:a.getSize(y.width)}).appendTo(p);function q(i){if(y.loadingOption){if(i){U.fadeIn("fast");f.addClass("gridy-fade");}else{U.fadeOut();f.removeClass("gridy-fade");}}}function x(){if(y.noResultOption){f.html('<p class="gridy-no-result">'+y.noResultText+"</p>");if(y.resultOption){G.html(G.html().replace(/\d+/g,"--"));}if(y.searchOption){R.focus().select();}}}var u=null;if(y.rowsNumber.length>0||y.messageOption||(y.findsName.length>0&&!y.searchOption)){u=b('<div class="gridy-footer"/>').appendTo(p);if(y.resize){u.css("width",a.getSize(y.width));}}var h=null;if(y.findsName.length>0){h=b('<div class="gridy-find-option"><select></select></div>').appendTo((y.searchOption)?d.children():u).children();var r=false,E="",g="",k="";for(var Y=0;Y<y.findsName.length;Y++){g=y.findsName[Y][0];k=y.findsName[Y][1];E+='<option value="'+g+'">'+k+"</option>";if(g==y.find){r=true;}}if(!r){h.html('<option value="'+y.find+'" checked="checked">'+y.find+"</option>");}h.append(E).val(y.find).change().change(function(i,ac){if(y.searchOption&&y.searchFocus){R.focus();}}).children('option[value="'+y.find+'"]').attr("checked","checked");}var X=null;if(y.rowsNumber.length>0){X=b('<div class="gridy-row-option"><select></select></div>').appendTo(u).children();var Z=(y.rows<1)?1:y.rows,N=false,E="",ab="";for(var Y=0;Y<y.rowsNumber.length;Y++){ab=y.rowsNumber[Y];if(ab==Z){N=true;}E+='<option value="'+ab+'">'+a.getNumber(ab)+"</option>";}if(!N){X.html('<option value="'+Z+'" checked="checked">'+a.getNumber(Z)+"</option>");}X.append(E).val(Z).change().change(function(i,ac){P(1,n.val(),s.val());}).children('option[value="'+Z+'"]').attr("checked","checked");}if(y.searchTarget){R.parent().appendTo(y.searchTarget);}if(y.findTarget){h.parent().appendTo(y.findTarget);}if(y.rowsTarget){X.parent().appendTo(y.rowsTarget);}var v=null;if(y.buttonOption){v=b('<div class="gridy-buttons"><div class="gridy-buttons-content"></div></div>').appendTo(p).children();if(y.resize){v.css("width",a.getSize(y.width));}}var e=null;if(y.messageOption){e=b('<div class="gridy-message"/>').appendTo(u);}function I(i){if(y.messageOption){e.html(i).show();setTimeout(function(){e.fadeOut();},y.messageTimer);}}P(y.page,y.sortName,y.sortOrder);function z(i){if(i){if(y.searchOption){R.removeAttr("readonly");W.removeAttr("disabled");}if(y.sortersName.length>0){J.children("a").click(H);l.children('a:not(".gridy-no-sort")').click(H);}if(y.buttonOption){v.children(':not(".gridy-button-reticence")').removeAttr("disabled");}if(y.findsName.length>0){h.removeAttr("disabled");}if(y.rowsNumber.length>0){X.removeAttr("disabled");}}else{if(y.searchOption){R.attr("readonly","readonly");W.attr("disabled","disabled");}if(y.sortersName.length>0){J.children("a").die("click");l.children('a:not(".gridy-no-sort")').die("click");}if(y.buttonOption){v.children().attr("disabled","disabled");}if(y.findsName.length>0){h.attr("disabled","disabled");}if(y.rowsNumber.length>0){X.attr("disabled","disabled");}}}function c(am,al,ac,au,at){if(typeof(am)=="string"){am=b.parseJSON(am);}if(y.before){var ak=y.before.apply(p,[am,al,ac,au]);if(ak){am=ak;}}if(am.total==0){x();z(true);return;}else{if(y.sortersName.length>0){t.show();}}var ao=am[y.root];f.html(b("#"+y.template).tmpl(ao));if(y.evenOdd){f.children(":even").addClass("gridy-even").end().children(":odd").addClass("gridy-odd");}if(y.colsWidth){f.children().addClass("gridy-row").each(function(){b(this).children().addClass("gridy-column").each(function(i){b(this).width(y.colsWidth[i]);});});}var ar=am.total%at,ag=(am.total-ar)/at;if(ar>0){ag++;}if(y.resultOption){var av=y.resultText.replace(/{from}/,a.getNumber(al)).replace(/{to}/,a.getNumber(ag)).replace(/{total}/,a.getNumber(am.total));G.html(av);}if(y.buttonOption){if(am.total>at){var aq='<input type="button" value="..." disabled="disabled" class="gridy-button-reticence"/>&nbsp;',ay="",ad=0,ae=null,aj=1,ai=y.buttonMax,ap=(y.buttonMax%2==0);if(y.buttonMax>ag){ai=ag;}else{ai=y.buttonMax;}if(ap){ae=Math.ceil(ai/2);aj=al-ae+1;}else{ae=Math.floor(ai/2);aj=al-ae;}var af=parseInt(al)+ae;if(aj==0){af++;aj=1;}if(aj<0){af+=Math.abs(aj)+1;aj=1;}if(af>ag){if(aj>1){aj-=(af-ag);}af=ag;}var ah=ag>ai,an=ah&&al>((ap)?ae:ae+1),ax=ah&&al<(ag-ae);if(an){ay='<input type="button" value="&lsaquo;" alt="'+y.buttonBackTitle+'" title="'+y.buttonBackTitle+'" class="gridy-back"/>&nbsp;';ay+=aq;}for(var aw=aj;aw<=af;aw++){ad=a.getNumber(aw);ay+='<input type="button" value="'+ad+'" alt="'+ad+'" title="'+y.buttonTitle+" "+ad+'"/>&nbsp;';}if(ax){ay+=aq;ay+='<input type="button" value="&rsaquo;" alt="'+y.buttonNextTitle+'" title="'+y.buttonNextTitle+'" class="gridy-next"/>&nbsp;';}v.html(ay).children(':not(".gridy-button-reticence")').click(function(){P(parseInt(this.alt,10),n.val(),s.val());});if(an){v.children(".gridy-back").click(function(){P(al-1,n.val(),s.val());});}if(ax){v.children(".gridy-next").click(function(){P(al+1,n.val(),s.val());});}}else{v.empty();}b('input[value="'+a.getNumber(al)+'"]').attr("disabled","disabled").addClass("gridy-active");}L.val(al);n.val(ac);s.val(au);}function P(ae,ad,ac){z(false);q(true);var i=y.search,af=(y.rowsNumber.length>0)?X.val():y.rows,ag=(y.findsName.length>0)?h.val():y.find;if(y.searchOption){i=(R.val()==y.searchText)?"":R.val();if(y.searchFocus){R.focus();}}if(y.data!=null){c(y.data,ae,ad,ac);return;}if(y.debug){a.debug("query string: search="+i+"&page="+ae+"&sortName="+ad+"&sortOrder="+ac+"&find="+ag+"&rows="+af+y.params);}b.ajax({cache:y.cache,contentType:y.contentType,dataType:y.dataType,jsonp:y.jsonp,jsonpCallback:y.jsonpCallback,type:y.type,url:y.url,data:"search="+i+"&page="+ae+"&sortName="+ad+"&sortOrder="+ac+"&find="+ag+"&rows="+af+y.params,success:function(ai){c(ai,ae,ad,ac,af);var ah=(y.scroll)?"-scroll":"";if(y.hoverFx){f.children().mouseenter(function(){b(this).addClass("gridy-item-hover"+ah);}).mouseleave(function(){b(this).removeClass("gridy-item-hover"+ah);});}if(y.clickFx){f.children().click(function(aj){var ak=b(this);if(!aj.shiftKey){ak.parent().children(".gridy-item-active"+ah).removeClass("gridy-item-active"+ah);}ak.toggleClass("gridy-item-active"+ah);});}if(y.success){y.success();}},error:function(aj,ah,ai){I(a.getError(aj));if(y.error){y.error();}},complete:function(){q(false);z(true);if(y.scroll){if(y.height=="auto"){a.debug(O+": height attribute missing!");}f.css({border:"1px solid #BBB",overflow:"auto"}).children("div").addClass("gridy-scroll").end().children("div:last").css("border-bottom-color","#FFF");}if(y.complete){y.complete();}}});}return p;};b.fn.gridy.reload=function(f,e){var c=b(f),d=c.data("options");if(e!==undefined){b.each(e,function(g,h){if(d[g]===undefined){a.debug("'"+g+"' is an invalid attribute!");}else{if(h!=d[g]){d[g]=h;}}});c.data("options",d);}return c.gridy(d);};b.fn.gridy.defaults={arrowDown:"gridy-arrow-down",arrowNone:"gridy-arrow-none",arrowUp:"gridy-arrow-up",before:null,buttonBackTitle:"&lsaquo; Back",buttonMax:10,buttonNextTitle:"Next &rsaquo;",buttonOption:true,buttonsWidth:"auto",buttonTitle:"page",cache:false,clickFx:false,colsWidth:[],complete:null,contentType:"application/x-www-form-urlencoded; charset=utf-8",dataType:"json",debug:false,error:null,evenOdd:false,find:"",findsName:[],findTarget:null,headersName:[],headersWidth:[],height:"auto",hoverFx:false,jsonp:false,jsonpCallback:"callback",loadingIcon:"gridy-loading",loadingOption:true,loadingText:"Loading...",messageOption:true,messageTimer:4000,noResultOption:true,noResultText:"No items found!",page:1,params:"",resize:true,resultOption:true,resultText:"Displaying {from} - {to} of {total} items",root:"entityList",rows:10,rowsNumber:[5,10,25,50,100],rowsTarget:null,scroll:false,search:"",searchButtonLabel:"search",searchButtonTitle:"Start the search",searchFocus:true,searchOption:true,searchTarget:null,searchText:"",sortersName:[],sorterWidth:"auto",sortName:"",sortOrder:"asc",success:null,template:"template",templateStyle:"gridy-default",type:"get",url:"/gridy",width:"auto"};})(jQuery);